<VirtualHost *:{{ zabbix_apache_vhost_port }}>
  ServerName {{ zabbix_server_url }}
  {% for alias in zabbix_server_url_aliases %}
  ServerAlias {{ alias }}
  {% endfor %}

  ## Vhost docroot
  DocumentRoot "/usr/share/zabbix"

{% if zabbix_apache_redirect and zabbix_apache_tls %}
  RewriteEngine On
  RewriteCond %{HTTPS} !=on
  RewriteRule ^/?(.*) https://%{SERVER_NAME}/$1 [R,L]
{% endif %}

{% set directory_paths = ['/usr/share/zabbix/conf', '/usr/share/zabbix/app', '/usr/share/zabbix/include', '/usr/share/zabbix/include/classes'] %}

  <Directory "/usr/share/zabbix">
    Options FollowSymLinks
    AllowOverride None
    Require all granted
  </Directory>

{% for my_path in directory_paths %}
  <Directory "{{ my_path }}">
    Require all granted
  </Directory>

{% endfor %}
  ## Logging
  ErrorLog "/var/log/{{ apache_log }}/{{ zabbix_server_url }}_error.log"
  ServerSignature Off
  CustomLog "/var/log/{{ apache_log }}/{{ zabbix_server_url }}_access.log" combined

  ## Rewrite rules
  RewriteEngine On
  RewriteRule ^$ /index.php [L]

  ## Custom fragment
  php_value max_execution_time {{ zabbix_web_max_execution_time | default('300') }}
  php_value memory_limit {{ zabbix_web_memory_limit | default('128M') }}
  php_value post_max_size {{ zabbix_web_post_max_size | default('16M') }}
  php_value upload_max_filesize {{ zabbix_web_upload_max_filesize | default('2M') }}
  php_value max_input_time {{ zabbix_web_max_input_time | default('300') }}
  # Set correct timezone.
  php_value date.timezone {{ zabbix_timezone }}
</VirtualHost>

{# Set up TLS vhosts #}
{% if zabbix_apache_tls and zabbix_apache_vhost_tls_port %}

<VirtualHost _default_:{{ zabbix_apache_vhost_tls_port }}>
  ServerName {{ zabbix_server_url }}
  {% for alias in zabbix_server_url_aliases %}
  ServerAlias {{ alias }}
  {% endfor %}

  ## Vhost docroot
  DocumentRoot "/usr/share/zabbix"

  SSLEngine on
  SSLCipherSuite {{ apache_ssl_cipher_suite }}
  SSLProtocol {{ apache_ssl_protocol }}
  SSLHonorCipherOrder On
  SSLCompression off
  SSLCertificateFile {{ zabbix_apache_tls_crt }}
  SSLCertificateKeyFile {{ zabbix_apache_tls_key }}
{% if zabbix_apache_tls_chain %}
  SSLCertificateChainFile {{ zabbix_apache_tls_chain }}
{% endif %}

{% set directory_paths = ['/usr/share/zabbix/conf', '/usr/share/zabbix/app', '/usr/share/zabbix/include', '/usr/share/zabbix/include/classes'] %}

  <Directory "/usr/share/zabbix">
    Options FollowSymLinks
    AllowOverride None
    Require all granted
  </Directory>

{% for my_path in directory_paths %}
  <Directory "{{ my_path }}">
    Require all granted
  </Directory>

{% endfor %}
  ## Logging
  ErrorLog "/var/log/{{ apache_log }}/{{ zabbix_server_url }}_tls_error.log"
  ServerSignature Off
  CustomLog "/var/log/{{ apache_log }}/{{ zabbix_server_url }}_tls_access.log" combined

  ## Rewrite rules
  RewriteEngine On
  RewriteRule ^$ /index.php [L]

  ## Custom fragment
  php_value max_execution_time {{ zabbix_web_max_execution_time | default('300') }}
  php_value memory_limit {{ zabbix_web_memory_limit | default('128M') }}
  php_value post_max_size {{ zabbix_web_post_max_size | default('16M') }}
  php_value upload_max_filesize {{ zabbix_web_upload_max_filesize | default('2M') }}
  php_value max_input_time {{ zabbix_web_max_input_time | default('300') }}
  # Set correct timezone.
  php_value date.timezone {{ zabbix_timezone }}
</VirtualHost>
{% endif %}
